<!doctype html>
<html lang="es">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Resultados ‚Äî Villa Parque Santa Ana 26 de Octubre 2025 </title>
<style>
  :root{
    --shadow:0 10px 30px rgba(0,0,0,.08);
    --bg:#f6f7fb; --ink:#0f172a;
    --gold1:#fff7d6;   --gold2:#ffefad;   --gold-border:#f5d34f;
    --silver1:#f5f7fb; --silver2:#e8edf6; --silver-border:#c9d3e6;
    --bronze1:#fff0e0; --bronze2:#ffd9b8; --bronze-border:#e6a66a;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:5;background:#fff;box-shadow:var(--shadow);padding:12px 16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  h1{margin:0;font-size:18px}
  .badge{background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;padding:4px 8px;font-size:12px}
  .wrap{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:16px}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#0f172a;color:#fff;font-weight:600;cursor:pointer}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  select{padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}

  /* KPIs */
  .kpis{display:grid;grid-template-columns:1fr;gap:12px}
  .card{
    background:#fff;border-radius:14px;box-shadow:var(--shadow);
    padding:14px;display:flex;justify-content:space-between;align-items:center;border:1px solid #e5e7eb
  }
  .kpi-title{font-size:12px;color:#64748b}
  .kpi-big{font-weight:800;font-size:26px}
  .kpi-sub{font-size:12px;color:#64748b}

  /* Lista vertical (ranking) */
  .list{display:flex;flex-direction:column;gap:10px}
  .item{
    background:#fff;border-radius:12px;box-shadow:var(--shadow);
    padding:12px; display:grid; grid-template-columns: 44px 56px 1fr auto;
    gap:12px; align-items:center; border:1px solid #e5e7eb;
  }
  .rank{width:44px;height:44px;display:flex;align-items:center;justify-content:center;
        border-radius:12px;background:#f1f5f9;border:1px solid #e2e8f0;font-weight:800}
  .name{font-weight:700;line-height:1.2;color:var(--ink)}
  .value{font-variant-numeric:tabular-nums;text-align:right;color:var(--ink)}
  .value .pct{font-weight:800}
  .value .num{font-size:13px;opacity:.8}

  /* Tama√±os por tier */
  .tier-1 .pct{font-size:34px}
  .tier-2 .pct{font-size:28px}
  .tier-3 .pct{font-size:22px}
  .tier-4{padding:8px; grid-template-columns: 36px 44px 1fr auto; }
  .tier-4 .rank{width:36px;height:36px;border-radius:10px}
  .tier-4 .name{font-size:16px;font-weight:600}
  .tier-4 .pct{font-size:18px}

  /* Logos */
  .logo{ width:40px; height:40px; object-fit:contain; }
  .tier-1 .logo{ width:56px; height:56px; }
  .tier-2 .logo{ width:48px; height:48px; }
  .tier-3 .logo{ width:42px; height:42px; }
  .tier-4 .logo{ width:32px; height:32px; }

  .empty{padding:20px;text-align:center;color:#64748b;border:1px dashed #e5e7eb;border-radius:12px;background:#fff}

  /* Resumen al pie */
  .summary{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .sum-card{
    background:#fff;border-radius:14px;box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column;gap:6px; border:1px solid #e5e7eb;
  }
  .sum-card .label{font-size:12px;color:#64748b}
  .sum-card .big{font-variant-numeric:tabular-nums;font-weight:800;font-size:22px;color:var(--ink)}
  .sum-card .sub{font-size:12px;color:#64748b}
  @media (max-width:900px){
    .summary{grid-template-columns:repeat(2,1fr)}
  }

  /* üéñÔ∏è Realce sutil Top 3 */
  .tier-1{ background:linear-gradient(180deg,var(--gold1),var(--gold2)); border-color:var(--gold-border); }
  .tier-2{ background:linear-gradient(180deg,var(--silver1),var(--silver2)); border-color:var(--silver-border); }
  .tier-3{ background:linear-gradient(180deg,var(--bronze1),var(--bronze2)); border-color:var(--bronze-border); }

  /* üñ®Ô∏è Vista de impresi√≥n */
  @media print{
    header, .toolbar { display:none !important; }
    body{ background:#fff; }
    .wrap{ padding:0; }
    .card, .item, .sum-card{ box-shadow:none; }
  }
</style>
<body>
<header>
  <h1>Resultados ‚Äî Villa Parque Santa Ana 26 de Octubre 2025</h1>
  <span id="status" class="badge">Listo</span>
</header>

<div id="captureArea" class="wrap">
  <div class="toolbar">
    <label for="mesaFiltro" class="badge">Mesa</label>
    <select id="mesaFiltro">
      <option value="">Todas</option>
      <option>8367</option><option>8368</option><option>8369</option><option>8370</option>
      <option>8371</option><option>8372</option>
      <option>8373</option><option>8374</option><option>8375</option><option>8376</option>
      <option>8377</option><option>8378</option><option>8379</option>
    </select>
    <span id="mesasInfo" class="badge">‚Äì</span>

    <button id="btnRefresh" class="btn">Refrescar</button>
    <button id="btnPrint" class="btn" title="Imprimir vista">Imprimir</button>
    <button id="btnJPG" class="btn" title="Descargar imagen JPG">Descargar JPG</button>

    <span class="badge">Fuente: Recuento </span>
    <span id="last" class="badge">Sin actualizar</span>
  </div>

  <!-- KPIs -->
  <div class="kpis">
    <div class="card">
      <div>
        <div class="kpi-title">Participaci√≥n</div>
        <div id="kpiPart" class="kpi-big">‚Äì</div>
        <div id="kpiPartSub" class="kpi-sub"></div>
      </div>
    </div>
  </div>

  <!-- Ranking -->
  <div id="list" class="list"></div>
  <div id="empty" class="empty" style="display:none;">Sin datos todav√≠a.</div>

  <!-- Resumen -->
  <div id="resumen" class="summary"></div>
</div>

<!-- html2canvas para exportar JPG -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
/* ====== CONFIG ====== */
const SUPABASE_URL = 'https://jyxxflkxhlekyredxjfm.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5eHhmbGt4aGxla3lyZWR4amZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NjAyODUsImV4cCI6MjA3NzAzNjI4NX0.3E63g4A4MGvm7q1UBLosCKE1QZaAmqrGpCN06koIlKg';

/* Logos (PNG en assets/logos/) */
const LOGO_FILE = {
  "Partido Libertario": "partido-libertario.png",
  "Alianza Fuerza Patria": "alianza-fuerza-patria.png",
  "Alianza Ciudadanos": "alianza-ciudadanos.png",
  "Uni√≥n Popular Federal": "union-popular-federal.png",
  "Alianza Encuentro por la Rep√∫blica": "alianza-encuentro-por-la-republica.png",
  "Frente Federal de Acci√≥n Solidaria": "frente-federal-accion-solidaria.png",
  "Pol√≠tica Abierta para la Integridad Social (PAIS)": "pais.png",
  "Alianza C√≥rdoba Te Quiero": "alianza-cordoba-te-quiero.png",
  "Partido Dem√≥crata": "partido-democrata.png",
  "Acci√≥n Para el Cambio (APEC)": "apec.png",
  "Defendamos C√≥rdoba": "defendamos-cordoba.png",
  "Frente de Izquierda y de los Trabajadores - UNIDAD": "fit-unidad.png",
  "Alianza La Libertad Avanza": "la-libertad-avanza.png",
  "Uni√≥n C√≠vica Radical": "ucr.png",
  "PRO - Propuesta Republicana": "pro.png",
  "Movimiento Avanzada Socialista": "mas.png",
  "FE": "fe.png",
  "Alianza Provincias Unidas": "provincias-unidas.png"
};
function logoPath(n){return LOGO_FILE[n]?`assets/logos/${LOGO_FILE[n]}`:''}

/* Total mesas (indicador) */
const TODAS_MESAS = ['8367','8368','8369','8370','8371','8372','8373','8374','8375','8376','8377','8378','8379'];

/* Orden oficial de listas */
const LISTAS_ORDEN = [
  "Partido Libertario","Alianza Fuerza Patria","Alianza Ciudadanos","Uni√≥n Popular Federal",
  "Alianza Encuentro por la Rep√∫blica","Frente Federal de Acci√≥n Solidaria",
  "Pol√≠tica Abierta para la Integridad Social (PAIS)","Alianza C√≥rdoba Te Quiero","Partido Dem√≥crata",
  "Acci√≥n Para el Cambio (APEC)","Defendamos C√≥rdoba",
  "Frente de Izquierda y de los Trabajadores - UNIDAD","Alianza La Libertad Avanza","Uni√≥n C√≠vica Radical",
  "PRO - Propuesta Republicana","Movimiento Avanzada Socialista","FE","Alianza Provincias Unidas"
];

/* Helpers */
const $=id=>document.getElementById(id);
const status=t=>$('status').textContent=t;
function fmt(n){return new Intl.NumberFormat('es-AR').format(n);}
function pct(n,d){return d?(n/d*100).toFixed(1):'0.0';}
function now(){return new Date().toLocaleString('es-AR');}

/* Fetch util */
async function fetchJSON(url){
  const r=await fetch(url,{headers:{apikey:SUPABASE_ANON_KEY,Authorization:'Bearer '+SUPABASE_ANON_KEY}});
  if(!r.ok)throw new Error(`HTTP ${r.status} ${await r.text()}`);
  return r.json();
}

/* Carga cruda desde cargas_mesa (opcionalmente filtrada por mesa) */
async function fetchCargas(mesa){
  const base = `${SUPABASE_URL}/rest/v1/cargas_mesa?select=mesa,listas,votos,blancos,nulos,recurridos,sobres,electores`;
  const url = mesa ? `${base}&mesa=eq.${mesa}` : base;
  return fetchJSON(url);
}

/* Agregaci√≥n en cliente */
function aggregate(rows){
  let blancos=0,nulos=0,recurridos=0,sobres=0,electores=0;
  const map = new Map(LISTAS_ORDEN.map(n=>[n,0]));

  rows.forEach(r=>{
    blancos += +r.blancos||0;
    nulos += +r.nulos||0;
    recurridos += +r.recurridos||0;
    sobres += +r.sobres||0;
    electores += +r.electores||0;

    const listas = Array.isArray(r.listas)?r.listas:[];
    const votos  = Array.isArray(r.votos)?r.votos:[];
    const m = Math.min(listas.length, votos.length);
    for(let i=0;i<m;i++){
      const nombre = listas[i];
      const v = +votos[i]||0;
      if(!map.has(nombre)) map.set(nombre,0);
      map.set(nombre, map.get(nombre)+v);
    }
  });

  const ranking = Array.from(map.entries())
    .map(([lista,total_votos])=>({lista,total_votos}))
    .sort((a,b)=>b.total_votos - a.total_votos)
    .map((row,idx)=>({...row, ranking: idx+1}));

  const afirmativos = ranking.reduce((a,b)=>a+(+b.total_votos||0),0);
  return { ranking, blancos, nulos, recurridos, sobres, electores, afirmativos };
}

/* Render */
function renderLista(ranking, totalAfirm){
  const list=$('list'),empty=$('empty');
  list.innerHTML='';
  if(!ranking?.length || totalAfirm===0){
    empty.style.display='block'; return;
  }
  empty.style.display='none';

  ranking.forEach(r=>{
    const rank=+r.ranking||999;
    const votos=+r.total_votos||0;
    const tier = rank==1?'tier-1':rank==2?'tier-2':rank==3?'tier-3':'tier-4';
    const src = logoPath(r.lista);

    const el=document.createElement('div');
    el.className=`item ${tier}`;
    el.innerHTML=`
      <div class="rank">#${rank}</div>
      <div>${src?`<img class="logo" src="${src}" alt="${r.lista}" crossOrigin="anonymous" onerror="this.style.display='none'">`:''}</div>
      <div class="name">${r.lista}</div>
      <div class="value">
        <div class="pct">${pct(votos,totalAfirm)}%</div>
        <div class="num">${fmt(votos)} votos</div>
      </div>
    `;
    list.appendChild(el);
  });
}

function renderResumen({afirm,blancos,nulos,recurridos}){
  const total=afirm+blancos+nulos+recurridos;
  const div=$('resumen');
  div.innerHTML=`
    <div class="sum-card"><div class="label">Afirmativos</div><div class="big">${fmt(afirm)}</div><div class="sub">${pct(afirm,total)}% del total</div></div>
    <div class="sum-card"><div class="label">Blancos</div><div class="big">${fmt(blancos)}</div><div class="sub">${pct(blancos,total)}% del total</div></div>
    <div class="sum-card"><div class="label">Nulos</div><div class="big">${fmt(nulos)}</div><div class="sub">${pct(nulos,total)}% del total</div></div>
    <div class="sum-card"><div class="label">Recurridos/Impugnados</div><div class="big">${fmt(recurridos)}</div><div class="sub">${pct(recurridos,total)}% del total</div></div>
  `;
}

function renderParticipacion({sobres,electores}){
  const p = electores>0 ? (sobres/electores*100) : 0;
  $('kpiPart').textContent = `${p.toFixed(1)}%`;
  $('kpiPartSub').textContent = `${fmt(sobres)} sobres / ${fmt(electores)} electores`;
}

/* Ciclo */
let timer=null;
async function load(){
  try{
    status('Cargando‚Ä¶'); $('btnRefresh').disabled=true;
    const mesa = $('mesaFiltro').value || '';
    const rows = await fetchCargas(mesa);

    // Indicador de mesas con datos
    const mesasInfoEl = $('mesasInfo');
    const mesasConDatos = new Set(rows.map(r => String(r.mesa))).size;
    if (mesa) {
      const cargasMesa = rows.length;
      mesasInfoEl.textContent = `Mesa ${mesa}: ${cargasMesa} carga${cargasMesa!==1?'s':''}`;
    } else {
      mesasInfoEl.textContent = `${mesasConDatos}/${TODAS_MESAS.length} mesas con datos`;
    }

    const agg = aggregate(rows);
    renderLista(agg.ranking, agg.afirmativos);
    renderParticipacion({sobres:agg.sobres, electores:agg.electores});
    renderResumen({afirm:agg.afirmativos, blancos:agg.blancos, nulos:agg.nulos, recurridos:agg.recurridos});
    status('Listo'); $('last').textContent = `Actualizado: ${now()}${mesa?` | Mesa ${mesa}`:''}`;
  }catch(e){
    status('Error'); $('last').textContent = e.message; console.error(e);
  }finally{
    $('btnRefresh').disabled=false;
  }
}
$('btnRefresh').addEventListener('click', load);
$('mesaFiltro').addEventListener('change', load);
function startAuto(){ if(timer) clearInterval(timer); timer=setInterval(load, 20000); }

/* üñ®Ô∏è / üñºÔ∏è Acciones */
$('btnPrint').addEventListener('click', ()=> {
  window.print();
});
$('btnJPG').addEventListener('click', async ()=>{
  try{
    const area = document.getElementById('captureArea');
    // Esperar un frame por si hubo cambios visuales
    await new Promise(r=>requestAnimationFrame(r));
    const canvas = await html2canvas(area, {
      scale: 2,        // mayor nitidez
      useCORS: true,   // permitir logos externos si aplica
      backgroundColor: '#ffffff',
      logging: false
    });
    const dataURL = canvas.toDataURL('image/jpeg', 0.92);
    const mesa = $('mesaFiltro').value || 'todas';
    const a = document.createElement('a');
    a.href = dataURL;
    a.download = `dashboard-${mesa}.jpg`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }catch(err){
    console.error(err);
    alert('No se pudo exportar la imagen. Prob√° nuevamente.');
  }
});

/* Init */
load(); startAuto();
</script>
</body>
</html>
